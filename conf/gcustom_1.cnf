[mariadb]

# --- Core MariaDB Settings ---
# Binary logging format (Required for Galera: ROW)
binlog_format=ROW
# Storage engine used for Galera
default_storage_engine=InnoDB
# InnoDB lock mode for auto-increment (Required for Galera: 2)
innodb_autoinc_lock_mode=2
# Enable individual file per table
innodb_file_per_table=1
# Maximum number of simultaneous connections
max_connections=1024
# Global bind address to allow remote connections
bind-address=0.0.0.0

# --- Galera Cluster Configuration ---
# Enable Galera replication
wsrep_on=ON
# Path to the Galera library
wsrep_provider=/usr/lib/galera/libgalera_smm.so
# IP addresses of all cluster nodes
wsrep_cluster_address="gcomm://10.6.0.11,10.6.0.12,10.6.0.13"
# Logical name of the cluster
wsrep_cluster_name="galera_cluster"
# Method used for State Snapshot Transfer (SST)
wsrep_sst_method=mariabackup
# Authentication credentials for SST
wsrep_sst_auth="sst_user:sstpass"
# Number of threads to use for parallel slave applying
wsrep_slave_threads=4

# --- Galera Local Node Configuration ---
# Local node network address
wsrep_node_address="10.6.0.11"
# Local node name
wsrep_node_name="galera01"
# Node identifier for identification in replication
report_host="serveur1"
# Unique server identifier
server_id=1
# Log replication conflicts
wsrep_log_conflicts=ON
# Enable detailed conflict logging in provider options and tune Flow Control
wsrep_provider_options="cert.log_conflicts=YES;gcache.size=512M;evs.suspect_timeout=PT5S;evs.inactive_timeout=PT15S;evs.install_timeout=PT15S;gcs.fc_factor=0.8;gcs.fc_limit=32"

# --- Advanced Replication & Networking ---
# Enforce GTID consistency
gtid_strict_mode=1
# Trusted networks for PROXY protocol
proxy_protocol_networks=10.5.0.0/24,10.6.0.0/24
# Binary log expiration period (2 days)
binlog_expire_logs_seconds=172800

# --- InnoDB Settings ---
# Redo log flush frequency (0=Performance, 1=ACID)
innodb_flush_log_at_trx_commit = 0
# Use O_DSYNC to avoid 'Can't change size of file' errors on WSL2 bind mounts
innodb_flush_method = O_DSYNC
# InnoDB buffer pool size
innodb_buffer_pool_size = 1G
# Redo log file size
innodb_log_file_size = 256M
# Define temporary data file path with a max size
innodb_temp_data_file_path = ibtmp1:12M:autoextend:max:5G

# --- Cache Settings ---
# Disable query cache (Incompatible with high concurrency)
query_cache_size = 0
query_cache_type = 0

# --- Performance Schema (PFS) ---
# Enable Performance Schema monitoring
performance_schema = ON
# Enable statement history consumers
performance-schema-consumer-events-statements-history-long = ON
performance-schema-consumer-events-statements-history = ON
performance-schema-consumer-events-statements-current = ON
# Enable stage monitoring
performance-schema-consumer-events-stages-current = ON
performance-schema-consumer-events-stages-history = ON
performance-schema-consumer-events-stages-history-long = ON
# Enable transaction monitoring
performance-schema-consumer-events-transactions-current = ON
performance-schema-consumer-events-transactions-history = ON
performance-schema-consumer-events-transactions-history-long = ON
# Enable wait monitoring
performance-schema-consumer-events-waits-current = ON
performance-schema-consumer-events-waits-history = ON
performance-schema-consumer-events-waits-history-long = ON
# Enable all instrumentation by default
performance-schema-instrument = '%=ON'
# Maximum digest length for statement tracking
max-digest-length = 2048
performance-schema-max-digest-length = 2048

# --- Slow Query Logging ---
# Enable the slow query log
slow_query_log = 1
# Log queries slower than 2 seconds
long_query_time = 2.0
# Only log 1 out of every 5 slow queries (sampling)
log_slow_rate_limit = 5
