#!/bin/bash
# Primary node initialization script
# Executed on first start of pg_node1 to configure streaming replication

set -e

echo ">> ðŸ”§ Configuring PostgreSQL Primary for streaming replication..."

# Create replication user
psql -U postgres -c "CREATE ROLE repli_user WITH REPLICATION LOGIN PASSWORD 'replipass';" 2>/dev/null || true

# Configure pg_hba.conf for replication and PgPool-II access
cat >> "$PGDATA/pg_hba.conf" <<'EOF'

# Replication and PgPool-II access (trust for lab environment)
host    replication     repli_user      10.8.0.0/24     trust
host    all             all             10.8.0.0/24     trust
EOF

# Configure postgresql.conf for streaming replication
cat >> "$PGDATA/postgresql.conf" <<'EOF'

# Streaming Replication Settings
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
hot_standby = on
hot_standby_feedback = on
wal_keep_size = 256MB
synchronous_commit = on
archive_mode = on
archive_command = '/bin/true'
EOF

echo ">> âœ… Primary configuration completed."
